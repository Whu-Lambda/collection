è¦ç‚¹ï¼š

- å‡½æ•°å£°æ˜ï¼šå‚æ•°åˆ—è¡¨ï¼Œè¿”å›å€¼åˆ—è¡¨
- å‡½æ•°ä½“æ„é€ 
- å‡½æ•°è°ƒç”¨
- é—­åŒ…

# å‡½æ•°å£°æ˜

Rust è¯­è¨€å‡½æ•°å£°æ˜æ–¹æ³•å¦‚ä¸‹ï¼š

```rust
fn function_name(param1: type1, param2: type2, ...) -> return_type {
   block
}
```

è¯·çœ‹ä¸€ä¸ªå…·ä½“çš„ä¾‹å­ï¼š

```rust
fn fib(n: u32) -> u32 {
    if n < 1 {
        return 0;
    } else {
        return n + fib(n - 1);
    }
}

assert_eq!(fib(0), 0);
assert_eq!(fib(1), 1);
assert_eq!(fib(4), 10);
assert_eq!(fib(5), 14);
```

è¿™æ˜¯ä¸€ä¸ªå…¸å‹çš„é€’å½’å‡½æ•°ï¼Œå±•ç¤ºäº†å‡½æ•°çš„å®šä¹‰ä¸è°ƒç”¨ã€‚

ğŸ’¡ `assert_eq!` å®å¤šç”¨äºæµ‹è¯•ï¼Œå¦‚æœä¸¤ä¸ªå‚æ•°ä¸ç›¸ç­‰ï¼Œå°±ä¼šæŠ¥é”™ã€‚



# å‡½æ•°å‚æ•°

æ¥ä¸‹æ¥æˆ‘ä»¬å°†å±•ç¤ºæ›´å¤šçš„å‚æ•°ä¼ é€’ä¾‹å­ã€‚

- ä¼ å€¼ï¼š

```rust
fn main() {
    let a = 5;
    println!("before: {}", a); // before: 5
    let y = add_one(a);
    println!("after: {}, y={}", a, y); // after: 5, y=6
}

fn add_one(x: i32) -> i32 {
    x + 1
}
```

- ä¼ é€’å¼•ç”¨ï¼š

```rust
fn main() {
    let a = 5;
    println!("before: {}", a); // before: 5
    let y = add_one(&a);
    println!("after: {}, y={}", a, y); // after: 5, y=6
}

fn add_one(x: &i32) -> i32 {
    x + 1
}
```

- å¯å˜å‡½æ•°å‚æ•°ï¼š

```rust
fn main() {
    let x = 5;
    let y = add_one(x);
    println!("x={}, y={}", x, y); // x=5, y=6
}

fn add_one(mut x: i32) -> i32 {
    x = x + 1;
    x
}
```

- ä¼ é€’å¯å˜å¼•ç”¨ï¼š

```rust
fn main() {
    let mut a = 5;
    println!("before: {}", a); // before: 5
    increase(&mut a);
    println!("after: {}", a); // after: 6
}

fn increase(x: &mut i32) {
    *x = *x + 1;
}
```

ä»¥ä¸Šå‡ ç§å‚æ•°ä¼ é€’æ–¹å¼ï¼Œä½ ä¼šè§‰å¾—ä¼ å€¼ä¸ä¼ å¼•ç”¨æ²¡å•¥åŒºåˆ«ï¼Œåœ¨æŸäº›æƒ…å†µä¸‹ç¡®å®æ˜¯è¿™æ ·ï¼Œä¸‹é¢çš„ä¾‹å­æ­ç¤ºäº†ä»–ä»¬çš„åŒºåˆ«ï¼š

```rust
fn main() {
    let name = String::from("Rust");
    println!("before: {}", name);
    let greeting = hello(name);
    println!("{}", greeting);
    println!("after: {}", name);
}

fn hello(name: String) -> String {
    format!("Hello, {}", name)
}
```

ç¼–è¯‘ä¼šå¾—åˆ°ä¸€ä¸ªé”™è¯¯ï¼š

```shell
 --> src\main.rs:6:27
  |
2 |     let name = String::from("Rust");
  |         ---- move occurs because `name` has type `String`, which does not implement the `Copy` trait
3 |     println!("before: {}", name);
4 |     let greeting = hello(name);
  |                          ---- value moved here
5 |     println!("{}", greeting);
6 |     println!("after: {}", name);
  |                           ^^^^ value borrowed here after move
```

æŠŠå®ƒæ”¹é€ ä¸ºä¼ å¼•ç”¨çš„ç‰ˆæœ¬ï¼š

```rust
fn main() {
    let name = String::from("Rust");
    println!("before: {}", name); // before: Rust
    let greeting = hello(&name);
    println!("{}", greeting); // Hello, Rust
    println!("after: {}", name); // after: Rust
}

fn hello(name: &String) -> String {
    format!("Hello, {}", name)
}
```

è¿™æ—¶ä½ å¯èƒ½æœ‰ä¸€è¿ä¸²çš„é—®é¢˜ï¼š

- ä»€ä¹ˆæ˜¯ `Copy trait`ï¼Œä»€ä¹ˆæ˜¯ `value moved`ï¼Œä»€ä¹ˆæ˜¯ `value borrowed`ï¼Ÿ
- ä¸ºä»€ä¹ˆå­—ç¬¦ä¸²ä¸ç”¨ `let name = "Rust";`ï¼Œè€Œè¦ç”¨ `let name = String::from("Rust");`ï¼Ÿ

è¿™é‡Œå…ˆä¸å…ˆå›ç­”è¿™äº›é—®é¢˜ï¼Œä¸€æ–¹é¢æ˜¯ç»™è¯»è€…ç•™ä¸‹æ€è€ƒçš„ç©ºé—´ï¼Œå¦ä¸€æ–¹é¢æ˜¯æˆ‘ä»¬ä¼šåœ¨æ¥ä¸‹æ¥çš„ç¬”è®°ä¸­è®²è¿°ã€‚

ğŸ’¡ æˆ‘ä»¬å¯¹ä»¥ä¸Šå‡ ç§ä¼ å‚æ–¹å¼ä½œä¸€ä¸ªå»ºè®®ï¼šæ•°å­—ç±»å‹å‚æ•°ç”¨ä¼ å€¼çš„æ–¹æ³•ï¼Œå…¶ä»–ç±»å‹çš„å‚æ•°å°½é‡ç”¨å¼•ç”¨ã€‚

# è¿”å›å€¼

Rust å‡½æ•°ä¹Ÿæ˜¯è¡¨è¾¾å¼ï¼Œè¿”å›å€¼çš„æ–¹æ³•ä¸ä¹‹å‰å­¦è¿‡çš„è¡¨è¾¾å¼ç±»ä¼¼ï¼š

```rust
fn add(x: i32, y: i32) -> i32 {
    x + y
}

assert_eq!(add(1, 1), 2);
```

Rust å‡½æ•°é™¤äº†å¯ä»¥ç”¨ `return expr;`è¿”å›å€¼å¤–ï¼Œè¿˜å¯ä»¥åœ¨å‡½æ•°ä½“æœ€åç”¨ä¸å¸¦åˆ†å·çš„è¡¨è¾¾å¼è¿”å›å€¼ã€‚å¦‚æœå‡½æ•°ä¸æ˜¾ç¤ºè¿”å›å€¼ï¼Œå¯ä»¥ä¸å†™è¿”å›å€¼ç±»å‹ï¼š

```rust
fn hello(name: &str) {
    println!("Hello, {}", name);
}

hello("Rust");
```

ğŸ’¡ ä¸æ˜¾ç¤ºè¿”å›å€¼å…¶å®æ˜¯è¿”å› `()`ã€‚

# é—­åŒ…ï¼ˆClosuresï¼‰

Rust çš„é—­åŒ…æ˜¯åŒ¿åå‡½æ•°ï¼Œé—­åŒ…å¯ä»¥ç»‘å®šåˆ°å˜é‡ä¸Šï¼Œä¹Ÿå¯ä»¥ä½œä¸ºå…¶ä»–å‡½æ•°çš„å‚æ•°ã€‚é—­åŒ…ä¸å‡½æ•°ç±»ä¼¼ï¼Œéƒ½å°è£…äº†ä¸€å®šçš„åŠŸèƒ½ï¼Œä¸å‡½æ•°ä¸åŒçš„æ˜¯ï¼Œé—­åŒ…èƒ½æ•è·ç¯å¢ƒå˜é‡ï¼Œå…ˆçœ‹ä¸€ä¸ªä¾‹å­ï¼š

```rust
fn main() {
    let color = String::from("green");
    let print = || println!("`color`: {}", color);
    print(); // `color`: green
}
```

ğŸ“è¦ç‚¹æ€»ç»“ï¼š

- é—­åŒ…çš„å®šä¹‰å¦‚ä¸‹ï¼š`|param1, param2, ...| {  block }`ï¼Œåªæœ‰ä¸€æ¡è¯­å¥çš„æ—¶å€™å¤§æ‹¬å·å¯ä»¥çœç•¥ï¼Œå‚æ•°çš„ç±»å‹æç¤ºä¹Ÿå¯ä»¥çœç•¥ã€‚
- å¯ä»¥çœ‹åˆ°æˆ‘ä»¬å®šä¹‰äº†ä¸€ä¸ªé—­åŒ…ï¼š`|| println!("`color`: {}", color);`ï¼Œå¹¶æŠŠå®ƒç»‘å®šåˆ°  `print` å˜é‡ï¼Œç„¶åå°±å¯ä»¥åƒå‡½æ•°è°ƒç”¨é‚£æ ·ä½¿ç”¨é—­åŒ…ã€‚
- å€¼å¾—æ³¨æ„çš„æ˜¯é—­åŒ…ä½¿ç”¨äº†å¤–éƒ¨å˜é‡ `color`ï¼Œè€Œè¿™ä¸ªå˜é‡å¹¶ä¸æ˜¯å®ƒçš„å‚æ•°ï¼Œè¿™å°±æ˜¯æ‰€è°“çš„é—­åŒ…å¯ä»¥æ•è·ç¯å¢ƒå˜é‡ã€‚

é—­åŒ…ä¸»è¦çš„åº”ç”¨é¢†åŸŸæ˜¯å‡½æ•°å¼ç¼–ç¨‹ï¼Œç»“åˆè¿­ä»£å™¨å¯ä»¥æ¸…æ™°çš„è¡¨è¾¾ä¸€äº›è®¡ç®—è¿‡ç¨‹ï¼š

```rust
fn main() {
    let upper = 1000;

    let sum_of_squared_odd_numbers: u32 = (0..)
        .map(|n| n * n)
        .take_while(|&n_squared| n_squared < upper)
        .filter(|&n_squared| n_squared % 2 == 1)
        .fold(0, |acc, n_squared| acc + n_squared);

    println!("functional style: {}", sum_of_squared_odd_numbers);
}
```

ä¸Šè¿°è®¡ç®—è¿‡ç¨‹ä¸€ç¯æ‰£ä¸€ç¯ï¼Œå°±åƒæµæ°´çº¿ä¸€æ ·ã€‚ä»¥ä¸Šä¾‹å­è¡¨æ˜ï¼šæœ‰äº›å‡½æ•°çš„å‚æ•°å¹¶ä¸æ˜¯æ•°å­—è¿™æ ·çš„å€¼ï¼Œè€Œæ˜¯ä¸€ç§æ–¹æ³•ç­–ç•¥ï¼Œè¿™é‡Œæ¶‰åŠä¸€ä¸ªæ€ç»´çš„è½¬å˜ï¼š**æŠŠè®¡ç®—è¿‡ç¨‹å½“åšæ•°æ®**ï¼Œè¿™æ ·å°±å¯ä»¥æŠŠå‡½æ•°å½“åšæŸäº›å‡½æ•°å‚æ•°ä¸è¿”å›å€¼ï¼Œè‡ªç„¶è€Œç„¶å°±äº§ç”Ÿäº†ä¸€ä¸ªæ¦‚å¿µï¼š**é«˜é˜¶å‡½æ•°**ã€‚æ‰€è°“çš„é«˜é˜¶å‡½æ•°å°±æ˜¯ä»¥å…¶ä»–å‡½æ•°ä¸ºå‚æ•°ï¼Œæˆ–è€…è¿”å›å‡½æ•°çš„å‡½æ•°ã€‚

ğŸ’¡ æœ‰ä¸€ç±»å‡½æ•°ç‰¹åˆ«æœ‰æ„æ€ï¼šå®ƒä»¥ä¸€äº›ç®€å•çš„å‡½æ•°ä¸ºå‚æ•°ï¼Œç„¶åè¿”å›ä¸€ä¸ªå¤æ‚çš„å‡½æ•°ï¼Œç§°ä¸º**ç»„åˆå­**ï¼ˆCombinatorsï¼‰ï¼Œè¿™æ˜¯ä¸€ç§ç¨‹åºè®¾è®¡é£æ ¼ï¼ŒRust è¯­è¨€æœ‰ç€å¹¿æ³›çš„åº”ç”¨ã€‚

æ›´å¤šèµ„æ–™ï¼šhttps://learning-rust.github.io/docs/e6.combinators.htmlã€‚

â„¹ï¸ æœ‰å…³è¿­ä»£å™¨æˆ‘ä»¬ç•™åœ¨åé¢å­¦ä¹ ã€‚

# Rust é—­åŒ…æ•è·å€¼çš„æ–¹å¼

â— é˜…è¯»ä»¥ä¸‹å†…å®¹å‰è¯·å­¦ä¹  Rust æ‰€æœ‰æƒæœºåˆ¶ã€‚

Rust æœ‰ä¸‰ç§æ•è·å€¼çš„æ–¹å¼ï¼š

- `Fn`: æ•è·å¼•ç”¨ (`&T`)
- `FnMut`: æ•è·å¯å˜å¼•ç”¨ (`&mut T`)
- `FnOnce`: æ•è·å€¼ (`T`)

ä¸ºäº†æ­ç¤ºä»–ä»¬çš„åŒºåˆ«ï¼Œå…ˆçœ‹å¦‚ä¸‹ç¤ºä¾‹ï¼š

```rust
fn main() {
    let hello_str = String::from("Hello");
    let f = || drop(hello_str);

    f();
    f();
}
```

ç¼–è¯‘ç»“æœï¼š

```rust
   |
12 |     f();
   |     --- `f` moved due to this call
13 |     f();
   |     ^ value used here after move
   |
note: closure cannot be invoked more than once because it moves the variable `hello_str` out of its environment
  --> src\main.rs:10:21
   |
10 |     let f = || drop(hello_str);
   |                     ^^^^^^^^^
note: this value implements `FnOnce`, which causes it to be moved when called
  --> src\main.rs:12:5
   |
12 |     f();
   |     ^
```

æç¤ºä¿¡æ¯çš„ä¸»è¦å†…å®¹æ˜¯ï¼š`f()` è°ƒç”¨æŠŠ `hello_str` ä»ç¯å¢ƒç§»é™¤äº†ï¼Œæ‰€ä»¥åªèƒ½è°ƒç”¨ä¸€æ¬¡ï¼Œå®ƒå®ç°çš„æ˜¯ `FnOnce trait` ã€‚

å½“ç„¶ä»£ç çš„é€»è¾‘æ˜¯å°è¯•é‡Šæ”¾ `hello_str` ä¸¤æ¬¡ï¼Œè¿™æ˜¯ç»å…¸çš„é‡å¤é‡Šæ”¾ï¼ˆdouble freeï¼‰é”™è¯¯ï¼ŒRust è¯­è¨€ä¸ºæˆ‘ä»¬é¿å…äº†è¿™ä¸ªé”™è¯¯ã€‚

å†æ¥çœ‹ä¸€ä¸ªä¾‹å­ï¼š

```rust
fn call_twice<F>(closure: F)
where
    F: Fn(),
{
    closure();
    closure();
}
fn main() {
    let hello_str = String::from("Hello");
    let f = || drop(hello_str);

    call_twice(f);
}
```

ç¼–è¯‘ç»“æœï¼š

```shell
error[E0525]: expected a closure that implements the `Fn` trait, but this closure only implements `FnOnce`
  --> src\main.rs:10:13
   |
10 |     let f = || drop(hello_str);
   |             ^^^^^^^^---------^
   |             |       |
   |             |       closure is `FnOnce` because it moves the variable `hello_str` out of its environment
   |             this closure implements `FnOnce`, not `Fn`
11 | 
12 |     call_twice(f);
   |     ---------- the requirement to implement `Fn` derives from here
```

ğŸ’¡ æˆ‘ä»¬å¯ä»¥æŠŠ `FnOnce` å½¢è±¡çš„ç§°ä¸ºæ€å€¼çš„é—­åŒ…ã€‚ä½ å¯ä»¥å°è¯•æŠŠ `drop(hello_str);` æ¢æˆ`let another = hello_str;` ä»–ä»¬çš„æ•ˆæœç±»ä¼¼ã€‚

å†çœ‹ä¸€ä¸ªä¾‹å­ï¼š

```rust
fn main() {
    let name = String::from("Alice");
    let hello_from_thread = || format!("Hello: {}", name);
    let handler = std::thread::spawn(hello_from_thread);
    println!("{:?}", handler.join().unwrap());
}
```

è¿™ä¸ªä¾‹å­çš„é€»è¾‘éå¸¸ç®€å•ï¼Œå°±æ˜¯è°ƒç”¨å¤šçº¿ç¨‹å¤„ç†ä¸€äº›å·¥ä½œï¼Œç¼–è¯‘ç»“æœï¼š

```rust
error[E0373]: closure may outlive the current function, but it borrows `name`, which is owned by the current function
 --> src\main.rs:3:29
  |
3 |     let hello_from_thread = || format!("Hello: {}", name);
  |                             ^^                      ---- `name` is borrowed here
  |                             |
  |                             may outlive borrowed value `name`
  |
note: function requires argument type to outlive `'static`
 --> src\main.rs:4:19
  |
4 |     let handler = std::thread::spawn(hello_from_thread);
  |                   ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
help: to force the closure to take ownership of `name` (and any other referenced variables), use the `move` keyword
  |
3 |     let hello_from_thread = move || format!("Hello: {}", name);
  |                             ++++
```

ä»”ç»†åˆ†æä¸€ä¸‹ä»£ç ï¼šé—­åŒ…éœ€è¦ç¯å¢ƒå˜é‡  `name`ï¼Œç„¶è€Œï¼Œåœ¨å¦ä¸€ä¸ªçº¿ç¨‹è¿è¡Œçš„æ—¶å€™ï¼Œæ— æ³•ä¿è¯è¯¥ç¯å¢ƒèƒ½è·å–åˆ° `name`ï¼ˆoutliveï¼‰ï¼Œè§£å†³æ–¹æ³•æ˜¯ç”¨ `move` å…³é”®å­—å‘Šè¯‰é—­åŒ…æŠŠå€¼æ•´ä¸ªæ‹¿èµ°ï¼Œè€Œä¸æ˜¯å€Ÿç”¨ã€‚

å†ç»™ä¸€ä¸ªç±»ä¼¼çš„ä¾‹å­ï¼š

```rust
fn main() {
    let closure = get_print_closure();
    closure();
}

fn get_print_closure() -> impl Fn() {
    let name = String::from("User");
    move || {
        println!("Hello {}!", name);
    }
}
```

æ¥ä¸‹æ¥è®²è§£ä¸¤ä¸ªä¸¤ç§å€Ÿç”¨å€¼çš„é—­åŒ…ï¼š

```rust
fn main() {
    let name = String::from("Rust");
    let say_hello = || format!("Hello, {}", name);

    println!("{:?}", say_hello()); // "Hello, Rust"

    let mut plain_rust = String::from("Rust");

    let mut awesome_rust = || plain_rust.push_str(" is awesome");
    awesome_rust();
    println!("{:?}", plain_rust) // "Rust is awesome"
}
```

è¿™æ˜¯é—­åŒ…æœ€å¸¸è§çš„ç”¨æ³•ï¼Œåˆ†åˆ«ä½“ç°äº† `Fn, FnMut` ç‰¹æ€§ã€‚

æ›´å¤šèµ„æ–™è¯·é˜…è¯»ï¼šhttps://zhauniarovich.com/post/2020/2020-12-closures-in-rust/ã€‚

